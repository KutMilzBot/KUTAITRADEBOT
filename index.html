<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kut Milz TB</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    /* ABSOLUTE RULE: DO NOT TOUCH OR CHANGE ANY BACKGROUND CODE */
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 10px;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    .card {
      background: #1e293b;
      border: 1px solid #334155;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    .container-wrapper { width: 100%; max-width: 1200px; }

    .pill {
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
    }

    .status-pill {
      display: flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    #chart-container {
      width: 100%;
      height: 320px;
      background: #0b1220;
      border: 1px solid #334155;
      border-radius: 12px;
      overflow: hidden;
    }
    @media (min-width: 1024px) {
      #chart-container { height: 360px; }
    }
  </style>
</head>

<body>
<div class="container-wrapper">
  <h1 class="text-3xl font-bold text-center mb-6 text-white">Kut Milz TB</h1>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- LEFT COLUMN -->
    <div class="lg:col-span-1">

      <!-- BOT CONTROLS + LOGIN -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-sky-400">Bot Controls</h2>

        <!-- API TOKEN -->
        <div class="mb-3">
          <label for="api-token" class="block text-sm font-medium mb-1 text-slate-300">Deriv API Token</label>
          <div class="flex items-center rounded-lg bg-slate-700 border border-slate-600 focus-within:ring-2 focus-within:ring-sky-500 transition duration-150">
            <span class="p-3 text-sky-400">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3v2.25m-15.75 6a3 3 0 0 1 3-3h2.25m3.75-10.25v12a3 3 0 0 1-3 3h-2.25a3 3 0 0 1-3-3v-2.25m15.75-6a3 3 0 0 1-3 3h-2.25a3 3 0 0 1-3-3v-2.25m3.75 10.25v-12a3 3 0 0 1 3-3h2.25a3 3 0 0 1 3 3v2.25" />
              </svg>
            </span>
            <input type="password" id="api-token" placeholder="Paste your API token here..."
              class="flex-1 p-3 bg-transparent border-none text-slate-50 focus:ring-0 focus:outline-none placeholder-slate-400"
              autocomplete="off">
            <button id="toggle-visibility-btn" class="p-3 text-slate-400 hover:text-sky-300 transition duration-150"
              type="button" title="Show/Hide Token">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3.988 5.82a1.01 1.01 0 0 0-.083.125m3.668-.125c.112-.34.238-.667.38-.985a24.144 24.144 0 0 1 8.878 0c.142.318.268.645.38.985m3.668-.125c.112-.34.238-.667.38-.985a24.144 24.144 0 0 1 8.878 0c.142.318.268.645.38.985m-.12 11.082l-3.321-3.321a3.5 3.5 0 0 0-4.95-.99L3.988 5.82M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              </svg>
            </button>
          </div>
          <p id="token-error-message" class="text-sm text-red-400 mt-2 hidden">API token required.</p>
        </div>

        <!-- PASSWORD -->
        <div class="mb-3">
          <label for="start-password" class="block text-sm font-medium mb-1 text-slate-300">Start Password</label>
          <input type="password" id="start-password" value="$1977"
            class="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500"
            autocomplete="off">
          <p id="pw-error-message" class="text-sm text-red-400 mt-2 hidden">Wrong password — bot will NOT start.</p>
        </div>

        <!-- START/STOP -->
        <button id="toggle-bot-btn"
          class="w-full py-3 rounded-lg font-bold transition duration-200 bg-emerald-600 hover:bg-emerald-700 text-white shadow-lg">
          START BOT
        </button>

        <div class="mt-4 text-xs text-slate-400">
          Tip: Save token locally (auto). Works on Web / iOS / Android browsers.
        </div>

        <div class="mt-6 border-t border-slate-700 pt-4 space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-sm">Connection:</span>
            <span id="connection-status" class="status-pill bg-red-800 text-white">DISCONNECTED</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Account Type:</span>
            <span id="account-type" class="status-pill bg-slate-600 text-slate-200">UNKNOWN</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Trade Active:</span>
            <span id="trade-active-status" class="status-pill bg-slate-600 text-slate-300">Idle</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Current Mode:</span>
            <span id="mode-status" class="status-pill bg-indigo-800 text-white">SCALP</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">H4 Trend:</span>
            <span id="h4-trend-display" class="status-pill bg-slate-600 text-slate-300">OFF</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Reason Blocked:</span>
            <span id="block-reason-display" class="status-pill bg-slate-600 text-slate-300">None</span>
          </div>
        </div>
      </div>

      <!-- ACCOUNT SUMMARY -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-sky-400">Account Summary</h2>
        <div class="space-y-3">
          <div class="flex justify-between items-center border-b border-slate-700 pb-2">
            <span class="text-sm">Current Balance:</span>
            <span id="current-balance-display" class="text-lg font-bold text-yellow-400">...</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Session Profit (USD):</span>
            <span id="current-profit-display" class="text-lg font-bold text-slate-300">0.00</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Contract Sellable:</span>
            <span id="sellable-display" class="status-pill bg-red-500 text-white">NO</span>
          </div>
        </div>
      </div>

      <!-- CONFIDENCE METER -->
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-emerald-400">Confidence Meter</h2>
          <span id="confidence-pill" class="pill bg-slate-700 text-slate-200">0%</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
          <div id="confidence-bar" class="h-4 bg-emerald-500" style="width:0%"></div>
        </div>
        <div id="confidence-text" class="text-xs mt-2 text-slate-300">
          0% — Waiting for ticks...
        </div>
        <div class="text-xs text-slate-400 mt-2">
          Use this when Auto Trading is OFF to help decide manual entries. (Not financial advice.)
        </div>
      </div>

      <!-- SYSTEM LOG -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-amber-300">System Log</h2>
        <div class="p-3 bg-slate-900/40 border border-slate-700 rounded-lg text-xs whitespace-pre-wrap min-h-[120px] max-h-[220px] overflow-auto"
             id="system-log"></div>
        <div class="mt-3 flex gap-2">
          <button id="clear-log-btn" class="text-xs py-2 px-3 rounded bg-slate-600 hover:bg-slate-500 text-white">Clear Log</button>
          <button id="export-log-btn" class="text-xs py-2 px-3 rounded bg-slate-600 hover:bg-slate-500 text-white">Copy Log</button>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="lg:col-span-2">

      <!-- CLUSTER ALERT -->
      <div id="cluster-alert" class="card hidden border-yellow-500/40">
        <div class="flex items-start gap-3">
          <div class="text-yellow-400 text-xl">⚠️</div>
          <div>
            <div class="text-lg font-semibold text-yellow-300">Clustering Detected</div>
            <div id="cluster-text" class="text-sm text-slate-200 mt-1">
              3+ clusters in last 5 ticks suggests possible reversal/indecision.
            </div>
          </div>
        </div>
      </div>

      <!-- UPDATE TITLE (what you asked) -->
      <div class="card">
        <h2 class="text-xl font-semibold text-sky-400">Update Kut Milz TB (symbols + chart + fixes)</h2>
        <p class="text-xs text-slate-400 mt-2">
          Live ticks from Deriv API → Chart + Signal Engine + Auto/Manual controls.
        </p>
      </div>

      <!-- TRADE SETTINGS -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-sky-400">Trade Settings</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div>
            <label class="block text-sm font-medium mb-1">Select Market</label>
            <select id="symbolSelect"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
              <!-- Main Vols -->
              <option value="R_10">Volatility 10 Index (R_10)</option>
              <option value="R_25">Volatility 25 Index (R_25)</option>
              <option value="R_50">Volatility 50 Index (R_50)</option>
              <option value="R_75">Volatility 75 Index (R_75)</option>
              <option value="R_100" selected>Volatility 100 Index (R_100)</option>

              <!-- 1s Vols (common Deriv symbols; if yours differs, use Custom Symbol) -->
              <option value="1HZ10V">Volatility 10 (1s) (1HZ10V)</option>
              <option value="1HZ25V">Volatility 25 (1s) (1HZ25V)</option>
              <option value="1HZ50V">Volatility 50 (1s) (1HZ50V)</option>
              <option value="1HZ75V">Volatility 75 (1s) (1HZ75V)</option>
              <option value="1HZ100V">Volatility 100 (1s) (1HZ100V)</option>
            </select>
            <p class="text-xs text-slate-400 mt-2">
              Current symbol: <span id="currentSymbolLabel" class="text-sky-300 font-semibold">R_100</span>
            </p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Custom Symbol (optional)</label>
            <div class="flex gap-2">
              <input id="customSymbol" placeholder="Example: R_100 or 1HZ100V"
                class="flex-1 p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500"/>
              <button id="applySymbolBtn"
                class="py-2 px-3 rounded bg-sky-700 hover:bg-sky-800 text-white text-sm font-semibold">
                Apply
              </button>
            </div>
            <p class="text-xs text-slate-400 mt-2">
              If you’re on an account that doesn’t support Synthetic Volatility (e.g., some MT5/financial-only setups),
              ticks will fail and you’ll see a warning in the log. Use a Derived/Synthetic account token.
            </p>
          </div>

          <div class="md:col-span-2 grid grid-cols-2 gap-3">
            <button id="placeTradeBtn" class="py-3 rounded-xl font-bold bg-emerald-700 hover:bg-emerald-800 text-white">
              Place Trade (<span id="placeStakeLabel">$1.00</span>)
            </button>
            <button id="clearHistoryBtn" class="py-3 rounded-xl font-bold bg-red-700 hover:bg-red-800 text-white">
              Clear History
            </button>
            <button id="bulk3Btn" class="py-3 rounded-xl font-bold bg-fuchsia-700 hover:bg-fuchsia-800 text-white">
              Bulk 3 (<span id="bulk3Label">$3.00</span>)
            </button>
            <button id="bulk5Btn" class="py-3 rounded-xl font-bold bg-sky-700 hover:bg-sky-800 text-white">
              Bulk 5 (<span id="bulk5Label">$5.00</span>)
            </button>
          </div>

          <div class="md:col-span-2 flex items-center justify-between p-3 bg-slate-700/50 rounded-lg mt-1">
            <div class="flex items-center gap-3">
              <div class="text-purple-300 text-xl">⚡</div>
              <div>
                <div class="font-semibold text-slate-200">Auto Trading</div>
                <div class="text-xs text-slate-400">Turn OFF if you want to trade manually using the Confidence Meter</div>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="autoTradingToggle" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-slate-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-300 rounded-full peer
                peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px]
                after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
            </label>
          </div>

        </div>
      </div>

      <!-- TRADING PARAMETERS (manual tweak) -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-sky-400">Trading Parameters</h2>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="stakeAmount" class="block text-sm font-medium mb-1">Stake Amount (USD)</label>
            <input type="number" id="stakeAmount" value="1.00" step="0.01"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
          </div>

          <div>
            <label for="maxTradesPerSignal" class="block text-sm font-medium mb-1">Max Trades/Signal</label>
            <input type="number" id="maxTradesPerSignal" value="1" step="1"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
          </div>

          <div>
            <label for="duration" class="block text-sm font-medium mb-1">Duration</label>
            <input type="number" id="duration" value="5" step="1"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
          </div>

          <div>
            <label for="durationUnit" class="block text-sm font-medium mb-1">Duration Unit</label>
            <select id="durationUnit"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
              <option value="t">Ticks</option>
              <option value="s">Seconds</option>
              <option value="m">Minutes</option>
              <option value="h">Hours</option>
            </select>
          </div>

          <div>
            <label for="tpUSD" class="block text-sm font-medium mb-1">Take Profit (USD)</label>
            <input type="number" id="tpUSD" value="0.34" step="0.01"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
          </div>

          <div>
            <label for="slUSD" class="block text-sm font-medium mb-1">Stop Loss (USD)</label>
            <input type="number" id="slUSD" value="10.00" step="0.01"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
          </div>

          <!-- ✅ COOLDOWN IS BACK -->
          <div class="col-span-2">
            <label for="cooldownDuration" class="block text-sm font-medium mb-1">Cooldown Duration (s)</label>
            <input type="number" id="cooldownDuration" value="30" step="1"
              class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
          </div>
        </div>
      </div>

      <!-- PROTECTED DEFAULTS -->
      <div class="card">
        <div class="flex justify-between items-start mb-4 border-b border-slate-700 pb-3">
          <h2 class="text-xl font-semibold text-pink-400">Protected Defaults</h2>
          <button id="unlock-settings-btn"
            class="text-sm text-pink-400 hover:text-pink-300 font-medium py-1 px-3 rounded-full border border-pink-500 transition duration-150">
            Unlock
          </button>
        </div>

        <div class="space-y-4">
          <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
            <div class="flex flex-col sm:flex-row sm:items-center">
              <span class="text-sm font-medium text-slate-300 mr-4">Strategy Mode:</span>
              <span id="mode-pill" class="pill bg-indigo-600 text-white">SCALP</span>
            </div>
            <select id="mode-select"
              class="p-1 rounded bg-slate-600 text-xs border border-slate-500 focus:ring-indigo-500"
              disabled>
              <option value="SCALP">SCALP (Fast Tap-Out)</option>
              <option value="MOMENTUM">MOMENTUM (Trend + Breakout)</option>
              <option value="H4">H4 MODE (Strict Trend + Breakout)</option>
            </select>
          </div>

          <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
            <div class="flex flex-col sm:flex-row sm:items-center">
              <span class="text-sm font-medium text-slate-300 mr-4">Safe Mode:</span>
              <span id="safe-mode-indicator" class="pill bg-red-600 text-white">OFF</span>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="safe-mode-toggle" class="sr-only peer" disabled>
              <div class="w-11 h-6 bg-slate-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer
                peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px]
                after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
            </label>
          </div>

          <div class="text-center text-xs text-slate-500" id="safe-mode-status">
            Safe Mode is currently DISABLED.
          </div>

          <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
            <div class="flex flex-col sm:flex-row sm:items-center">
              <span class="text-sm font-medium text-slate-300 mr-4">Auto-resume after cooldown:</span>
              <span id="autoresume-indicator" class="pill bg-emerald-600 text-white">ON</span>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="autoresume-toggle" class="sr-only peer" disabled checked>
              <div class="w-11 h-6 bg-slate-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer
                peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px]
                after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
            </label>
          </div>
        </div>

        <div class="mt-4 pt-3 border-t border-slate-700">
          <p class="text-xs text-center text-slate-500">Kut Milz TB</p>
        </div>
      </div>

      <!-- LIVE CHART -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-sky-400">Live Chart</h2>
          <span id="chart-status" class="pill bg-slate-700 text-slate-200">WAITING</span>
        </div>
        <div id="chart-container"></div>
        <p class="text-xs text-slate-400 mt-2">
          Live chart from Deriv tick stream. Candles if supported; otherwise line fallback.
        </p>
      </div>

      <!-- MARKET INSIGHTS (fallback) -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-emerald-400">Market Insights ✨</h2>
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
          <button id="analyze-market-btn" class="flex-1 py-2 rounded-lg font-bold transition duration-200 bg-emerald-700 hover:bg-emerald-800 text-white shadow-lg">
            Analyze Market Sentiment ✨
          </button>
          <button id="assess-risk-btn" class="flex-1 py-2 rounded-lg font-bold transition duration-200 bg-pink-700 hover:bg-pink-800 text-white shadow-lg">
            Assess Strategy Risk ✨
          </button>
        </div>

        <div id="gemini-loading-indicator" class="hidden text-center text-sm text-yellow-500 py-4">
          Generating insight...
        </div>

        <div id="gemini-output" class="p-3 bg-slate-700 rounded-lg text-sm text-slate-100 min-h-[100px] whitespace-pre-wrap">
          Tap a button above for analysis. (Works without API key.)
        </div>

        <div class="mt-3 text-xs text-slate-400">
          Note: This is NOT financial advice. Signals can be wrong — always risk-manage.
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================================================
   SAFE DOM + LOG
========================================================= */
function $(id){ return document.getElementById(id); }
const LOG = $("system-log");
function logLine(msg){
  const t = new Date().toLocaleTimeString();
  const line = `[${t}] ${msg}`;
  console.log(line);
  if (LOG){
    LOG.textContent = (LOG.textContent ? (LOG.textContent + "\\n") : "") + line;
    LOG.scrollTop = LOG.scrollHeight;
  }
}

/* =========================================================
   CONFIG
========================================================= */
const API_URL = "wss://ws.binaryws.com/websockets/v3?app_id=1089";
const START_PASSWORD = "$1977";

/* =========================================================
   MODE DEFAULTS
   - Momentum best = Minutes (your request)
========================================================= */
const modeDefaults = {
  SCALP:   { stake:1.00, duration:5, durationUnit:"t", tp:0.34, sl:10.00, maxTrades:1, cooldown:30, tickBuf:6,  thr:0.015, trend:false, strict:false },
  MOMENTUM:{ stake:2.00, duration:1, durationUnit:"m", tp:0.60, sl:15.00, maxTrades:1, cooldown:45, tickBuf:10, thr:0.030, trend:true,  strict:false },
  H4:      { stake:2.00, duration:2, durationUnit:"m", tp:0.80, sl:20.00, maxTrades:1, cooldown:60, tickBuf:12, thr:0.040, trend:true,  strict:true  }
};

/* =========================================================
   STATE
========================================================= */
const appState = {
  ws: null,
  token: localStorage.getItem("derivToken") || "",
  isBotRunning: false,
  isAuthenticated: false,
  isEntryInProgress: false,

  symbol: "R_100",

  currentBalance: 0,
  sessionProfit: 0,

  tradeCounter: 0,
  currentContractId: null,
  is_sellable: 0,
  isSelling: false,

  mode: "SCALP",
  isSettingsLocked: true,
  isSafeMode: false,
  autoResume: true,
  autoTradingEnabled: true,

  stakeAmount: 1.00,
  duration: 5,
  durationUnit: "t",
  tpUSD: 0.34,
  slUSD: 10.00,
  maxTradesPerSignal: 1,
  cooldownDuration: 30,
  cooldownUntil: 0,

  tickBuffer: [],
  tickBufferSize: 6,
  momentumThreshold: 0.015,
  lastTick: null,

  lastDigits: [],

  pendingProposalId: null,

  useTrendFilter: false,
  breakoutStrict: false,
  trend: {
    enabled: false,
    status: "OFF",
    tfSeconds: 14400,
    emaFast: 20,
    emaSlow: 50,
    lastUpdated: 0,
    refreshMs: 60000
  },

  chart: {
    lastCandleTime: 0,
    lastOHLC: null,
    hasTick: false,
    seriesType: "line" // "candle" or "line"
  },

  account: {
    isDemo: null
  }
};

/* =========================================================
   DOM
========================================================= */
const dom = {
  toggleBotBtn: $("toggle-bot-btn"),
  unlockBtn: $("unlock-settings-btn"),

  apiToken: $("api-token"),
  tokenError: $("token-error-message"),
  pwInput: $("start-password"),
  pwError: $("pw-error-message"),
  toggleVisibilityBtn: $("toggle-visibility-btn"),

  connectionStatus: $("connection-status"),
  accountType: $("account-type"),
  tradeActiveStatus: $("trade-active-status"),
  modeStatus: $("mode-status"),
  modePill: $("mode-pill"),
  modeSelect: $("mode-select"),
  h4TrendDisplay: $("h4-trend-display"),
  blockReasonDisplay: $("block-reason-display"),

  balanceDisplay: $("current-balance-display"),
  profitDisplay: $("current-profit-display"),
  sellableDisplay: $("sellable-display"),

  stakeInput: $("stakeAmount"),
  durationInput: $("duration"),
  durationUnitInput: $("durationUnit"),
  tpInput: $("tpUSD"),
  slInput: $("slUSD"),
  maxTradesInput: $("maxTradesPerSignal"),
  cooldownInput: $("cooldownDuration"),

  safeToggle: $("safe-mode-toggle"),
  safeIndicator: $("safe-mode-indicator"),
  safeStatus: $("safe-mode-status"),

  autoResumeToggle: $("autoresume-toggle"),
  autoResumeIndicator: $("autoresume-indicator"),

  symbolSelect: $("symbolSelect"),
  currentSymbolLabel: $("currentSymbolLabel"),
  customSymbol: $("customSymbol"),
  applySymbolBtn: $("applySymbolBtn"),

  placeTradeBtn: $("placeTradeBtn"),
  clearHistoryBtn: $("clearHistoryBtn"),
  bulk3Btn: $("bulk3Btn"),
  bulk5Btn: $("bulk5Btn"),
  placeStakeLabel: $("placeStakeLabel"),
  bulk3Label: $("bulk3Label"),
  bulk5Label: $("bulk5Label"),
  autoTradingToggle: $("autoTradingToggle"),

  clusterAlert: $("cluster-alert"),
  clusterText: $("cluster-text"),

  clearLogBtn: $("clear-log-btn"),
  exportLogBtn: $("export-log-btn"),

  chartStatus: $("chart-status"),

  analyzeBtn: $("analyze-market-btn"),
  riskBtn: $("assess-risk-btn"),
  geminiOut: $("gemini-output"),
  geminiLoading: $("gemini-loading-indicator"),

  confidenceBar: $("confidence-bar"),
  confidenceText: $("confidence-text"),
  confidencePill: $("confidence-pill"),
};

/* =========================================================
   UI HELPERS
========================================================= */
function setStatusPill(el, text, cls){
  if (!el) return;
  el.textContent = text;
  el.className = `status-pill ${cls}`;
}
function setPill(el, text, cls){
  if (!el) return;
  el.textContent = text;
  el.className = `pill ${cls}`;
}
function setIfNotEditing(el, value){
  if (!el) return;
  if (document.activeElement === el) return;
  el.value = value;
}
function updateProfit(p){
  if (!dom.profitDisplay) return;
  dom.profitDisplay.textContent = p.toFixed(2);
  let color = "text-slate-300";
  if (p > 0) color = "text-emerald-400";
  if (p < 0) color = "text-red-400";
  dom.profitDisplay.className = `text-lg font-bold ${color}`;
}
function updateConnection(status, cls){
  setStatusPill(dom.connectionStatus, status, cls);
}
function updateTradeStatus(text, cls="bg-slate-600 text-slate-300"){
  setStatusPill(dom.tradeActiveStatus, text, cls);
}
function setSellable(isSellable){
  appState.is_sellable = isSellable;
  if (isSellable === 1) setStatusPill(dom.sellableDisplay, "YES", "bg-emerald-600 text-white");
  else setStatusPill(dom.sellableDisplay, "NO", "bg-red-500 text-white");
}
function updateAccountTypeUI(){
  if (appState.account.isDemo === true) setStatusPill(dom.accountType, "DEMO", "bg-yellow-600 text-white");
  else if (appState.account.isDemo === false) setStatusPill(dom.accountType, "REAL", "bg-emerald-600 text-white");
  else setStatusPill(dom.accountType, "UNKNOWN", "bg-slate-600 text-slate-200");
}
function updateTrendUI(){
  if (!dom.h4TrendDisplay) return;
  const t = appState.trend.enabled ? appState.trend.status : "OFF";
  let cls = "bg-slate-600 text-slate-300";
  if (t === "BULL") cls = "bg-emerald-600 text-white";
  if (t === "BEAR") cls = "bg-red-600 text-white";
  if (t === "NEUTRAL") cls = "bg-yellow-600 text-white";
  if (t === "ERROR") cls = "bg-red-800 text-white";
  setStatusPill(dom.h4TrendDisplay, t, cls);
}
function updateUI(){
  if (dom.modePill) dom.modePill.textContent = appState.mode;
  if (dom.modeStatus) dom.modeStatus.textContent = appState.mode;

  if (dom.safeIndicator){
    dom.safeIndicator.textContent = appState.isSafeMode ? "ON" : "OFF";
    dom.safeIndicator.className = `pill ${appState.isSafeMode ? "bg-emerald-600" : "bg-red-600"} text-white`;
  }
  if (dom.safeStatus){
    dom.safeStatus.textContent = appState.isSafeMode
      ? "Safe Mode is ENABLED. Stop-loss selling is allowed."
      : "Safe Mode is DISABLED.";
  }

  setIfNotEditing(dom.stakeInput, appState.stakeAmount.toFixed(2));
  setIfNotEditing(dom.durationInput, String(appState.duration));
  if (dom.durationUnitInput && document.activeElement !== dom.durationUnitInput) dom.durationUnitInput.value = appState.durationUnit;
  setIfNotEditing(dom.tpInput, appState.tpUSD.toFixed(2));
  setIfNotEditing(dom.slInput, appState.slUSD.toFixed(2));
  setIfNotEditing(dom.maxTradesInput, String(appState.maxTradesPerSignal));
  setIfNotEditing(dom.cooldownInput, String(appState.cooldownDuration));

  if (dom.modeSelect && document.activeElement !== dom.modeSelect) dom.modeSelect.value = appState.mode;
  if (dom.safeToggle && document.activeElement !== dom.safeToggle) dom.safeToggle.checked = appState.isSafeMode;

  if (dom.autoResumeIndicator){
    dom.autoResumeIndicator.textContent = appState.autoResume ? "ON" : "OFF";
    dom.autoResumeIndicator.className = `pill ${appState.autoResume ? "bg-emerald-600" : "bg-red-600"} text-white`;
  }
  if (dom.autoResumeToggle) dom.autoResumeToggle.checked = !!appState.autoResume;

  if (dom.currentSymbolLabel) dom.currentSymbolLabel.textContent = appState.symbol;
  if (dom.placeStakeLabel) dom.placeStakeLabel.textContent = `$${appState.stakeAmount.toFixed(2)}`;
  if (dom.bulk3Label) dom.bulk3Label.textContent = `$${(appState.stakeAmount*3).toFixed(2)}`;
  if (dom.bulk5Label) dom.bulk5Label.textContent = `$${(appState.stakeAmount*5).toFixed(2)}`;

  if (dom.autoTradingToggle) dom.autoTradingToggle.checked = !!appState.autoTradingEnabled;

  updateTrendUI();
  updateAccountTypeUI();

  if (dom.toggleBotBtn){
    if (appState.isBotRunning){
      dom.toggleBotBtn.textContent = "STOP BOT";
      dom.toggleBotBtn.className = "w-full py-3 rounded-lg font-bold transition duration-200 bg-red-600 hover:bg-red-700 text-white shadow-lg";
    } else {
      dom.toggleBotBtn.textContent = "START BOT";
      dom.toggleBotBtn.className = "w-full py-3 rounded-lg font-bold transition duration-200 bg-emerald-600 hover:bg-emerald-700 text-white shadow-lg";
    }
  }
}

/* =========================================================
   SETTINGS LOCK
========================================================= */
function setSettingsLock(isLocked){
  appState.isSettingsLocked = isLocked;
  const list = [
    dom.stakeInput, dom.durationInput, dom.durationUnitInput,
    dom.tpInput, dom.slInput, dom.maxTradesInput, dom.cooldownInput,
    dom.modeSelect, dom.safeToggle, dom.autoResumeToggle
  ].filter(Boolean);

  list.forEach(el => el.disabled = isLocked);

  if (dom.unlockBtn){
    dom.unlockBtn.textContent = isLocked ? "Unlock" : "Lock";
    dom.unlockBtn.className = isLocked
      ? "text-sm text-pink-400 hover:text-pink-300 font-medium py-1 px-3 rounded-full border border-pink-500 transition duration-150"
      : "text-sm text-white bg-pink-600 hover:bg-pink-700 font-medium py-1 px-3 rounded-full border border-pink-700 transition duration-150";
  }
}

/* =========================================================
   INPUT -> STATE (LIVE typing)
========================================================= */
function updateStateFromUI(){
  try{
    if (dom.stakeInput) appState.stakeAmount = parseFloat(dom.stakeInput.value) || 0;
    if (dom.durationInput) appState.duration = parseInt(dom.durationInput.value) || 0;
    if (dom.durationUnitInput) appState.durationUnit = dom.durationUnitInput.value;
    if (dom.tpInput) appState.tpUSD = parseFloat(dom.tpInput.value) || 0;
    if (dom.slInput) appState.slUSD = parseFloat(dom.slInput.value) || 0;
    if (dom.maxTradesInput) appState.maxTradesPerSignal = parseInt(dom.maxTradesInput.value) || 0;
    if (dom.cooldownInput) appState.cooldownDuration = parseInt(dom.cooldownInput.value) || 0;
    if (dom.autoResumeToggle) appState.autoResume = !!dom.autoResumeToggle.checked;
    if (dom.autoTradingToggle) appState.autoTradingEnabled = !!dom.autoTradingToggle.checked;
    updateUI();
  } catch(e){
    logLine("UI parse error: " + e.message);
  }
}

/* =========================================================
   MODE DEFAULTS
========================================================= */
function loadDefaults(mode){
  const d = modeDefaults[mode];
  if (!d) return;

  appState.mode = mode;
  appState.stakeAmount = d.stake;
  appState.duration = d.duration;
  appState.durationUnit = d.durationUnit;
  appState.tpUSD = d.tp;
  appState.slUSD = d.sl;
  appState.maxTradesPerSignal = d.maxTrades;
  appState.cooldownDuration = d.cooldown;

  appState.tickBufferSize = d.tickBuf;
  appState.momentumThreshold = d.thr;

  appState.useTrendFilter = !!d.trend;
  appState.breakoutStrict = !!d.strict;

  appState.trend.enabled = appState.useTrendFilter;
  appState.trend.status = appState.trend.enabled ? "LOADING" : "OFF";

  updateUI();
}

/* =========================================================
   CHART (candles if supported, else line)
========================================================= */
let chart = null;
let series = null;
let ro = null;

function initChart(){
  const container = $("chart-container");
  if (!container) return;

  if (typeof LightweightCharts === "undefined"){
    setPill(dom.chartStatus, "CHART CDN ERROR", "bg-red-700 text-white");
    logLine("Chart library failed to load.");
    return;
  }

  try { if (chart) chart.remove(); } catch(_){}

  chart = LightweightCharts.createChart(container, {
    width: container.clientWidth,
    height: container.clientHeight,
    layout: { background: { color:"#0b1220" }, textColor:"#e2e8f0" },
    grid: { vertLines: { color:"#243244" }, horzLines: { color:"#243244" } },
    rightPriceScale: { borderColor:"#334155" },
    timeScale: { borderColor:"#334155", timeVisible:true, secondsVisible:true }
  });

  // ✅ supports BOTH old + new versions of lightweight-charts
  series = null;
  appState.chart.seriesType = "line";

  try{
    if (typeof chart.addCandlestickSeries === "function"){
      series = chart.addCandlestickSeries({ priceLineVisible:false, lastValueVisible:true });
      appState.chart.seriesType = "candle";
      logLine("Chart ready (candles).");
    } else if (typeof chart.addSeries === "function" && LightweightCharts?.CandlestickSeries){
      series = chart.addSeries(LightweightCharts.CandlestickSeries, { priceLineVisible:false, lastValueVisible:true });
      appState.chart.seriesType = "candle";
      logLine("Chart ready (candles v5).");
    } else if (typeof chart.addLineSeries === "function"){
      series = chart.addLineSeries({ priceLineVisible:false });
      appState.chart.seriesType = "line";
      logLine("Chart ready (line fallback).");
    } else {
      throw new Error("No series method found");
    }
  } catch(e){
    // last resort line
    try{
      series = chart.addLineSeries({ priceLineVisible:false });
      appState.chart.seriesType = "line";
      logLine("Chart fallback forced to line.");
    }catch(err){
      logLine("Chart init failed: " + err.message);
      setPill(dom.chartStatus, "CHART ERROR", "bg-red-700 text-white");
      return;
    }
  }

  setPill(dom.chartStatus, "READY", "bg-emerald-700 text-white");

  if (ro) ro.disconnect();
  ro = new ResizeObserver(() => {
    try{
      chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
    }catch(_){}
  });
  ro.observe(container);

  // reset candle state
  appState.chart.lastCandleTime = 0;
  appState.chart.lastOHLC = null;
  appState.chart.hasTick = false;
}

/* candle builder (1s candles from tick stream) */
function updateChartFromTick(price){
  if (!series) return;

  const nowSec = Math.floor(Date.now()/1000);
  if (nowSec < appState.chart.lastCandleTime) return;

  if (appState.chart.seriesType === "line"){
    series.update({ time: nowSec, value: price });
    return;
  }

  // candle
  if (appState.chart.lastCandleTime === 0){
    appState.chart.lastCandleTime = nowSec;
    appState.chart.lastOHLC = { time: nowSec, open: price, high: price, low: price, close: price };
    series.update(appState.chart.lastOHLC);
    return;
  }

  if (nowSec === appState.chart.lastCandleTime){
    const c = appState.chart.lastOHLC;
    c.high = Math.max(c.high, price);
    c.low  = Math.min(c.low, price);
    c.close = price;
    series.update(c);
  } else {
    appState.chart.lastCandleTime = nowSec;
    appState.chart.lastOHLC = { time: nowSec, open: price, high: price, low: price, close: price };
    series.update(appState.chart.lastOHLC);
  }
}

/* =========================================================
   CONFIDENCE BAR (0-100)
   - Uses: momentum delta + breakout position + optional trend alignment
========================================================= */
function computeConfidence(){
  const buf = appState.tickBuffer;
  if (buf.length < Math.max(6, appState.tickBufferSize)) return 0;

  const first = buf[0];
  const last  = buf[buf.length-1];
  const delta = last - first;
  const absDelta = Math.abs(delta);

  const hi = Math.max(...buf);
  const lo = Math.min(...buf);
  const span = (hi - lo) || 1;

  // momentum score (0..60)
  const mScore = Math.max(0, Math.min(60, (absDelta / (appState.momentumThreshold || 0.000001)) * 10));

  // breakout score (0..25)
  // if CALL: last near hi, if PUT: last near lo
  const dir = absDelta < appState.momentumThreshold ? null : (delta > 0 ? "CALL" : "PUT");
  let bScore = 0;
  if (dir){
    const near = dir === "CALL" ? (1 - (hi - last)/span) : (1 - (last - lo)/span);
    bScore = Math.max(0, Math.min(25, near * 25));
  }

  // trend score (0..15)
  let tScore = 0;
  if (!appState.trend.enabled) tScore = 8; // neutral bonus
  else {
    if (dir === "CALL" && appState.trend.status === "BULL") tScore = 15;
    else if (dir === "PUT" && appState.trend.status === "BEAR") tScore = 15;
    else if (appState.trend.status === "NEUTRAL") tScore = 6;
    else tScore = 0;
  }

  const score = Math.max(0, Math.min(100, mScore + bScore + tScore));
  return score;
}

function renderConfidence(){
  const v = computeConfidence();
  if (dom.confidenceBar) dom.confidenceBar.style.width = `${v.toFixed(0)}%`;

  const good = v >= 70;
  const mid  = v >= 40 && v < 70;

  if (dom.confidenceBar){
    dom.confidenceBar.className = `h-4 ${good ? "bg-emerald-500" : mid ? "bg-yellow-500" : "bg-red-500"}`;
  }
  if (dom.confidencePill){
    setPill(dom.confidencePill, `${v.toFixed(0)}%`, good ? "bg-emerald-700 text-white" : mid ? "bg-yellow-700 text-white" : "bg-red-700 text-white");
  }
  if (dom.confidenceText){
    dom.confidenceText.textContent =
      v < 20 ? `${v.toFixed(0)}% — Weak / choppy. Better WAIT.` :
      v < 40 ? `${v.toFixed(0)}% — Low confidence. Careful.` :
      v < 70 ? `${v.toFixed(0)}% — Medium confidence. Prefer smaller stake.` :
               `${v.toFixed(0)}% — Stronger conditions. Still manage risk.`;
  }
}

/* =========================================================
   TREND (EMA20/EMA50) via H4 candles
========================================================= */
function calcEMA(values, period){
  if (!values || values.length < period) return null;
  const k = 2/(period+1);
  let ema = values.slice(0,period).reduce((a,b)=>a+b,0)/period;
  for (let i=period;i<values.length;i++) ema = values[i]*k + ema*(1-k);
  return ema;
}
function trendClassify(emaFast, emaSlow){
  if (emaFast == null || emaSlow == null) return "NEUTRAL";
  const diff = emaFast-emaSlow;
  const eps = Math.abs(emaSlow)*0.000001;
  if (diff > eps) return "BULL";
  if (diff < -eps) return "BEAR";
  return "NEUTRAL";
}
function requestH4Candles(){
  if (!appState.ws || !appState.isAuthenticated || !appState.trend.enabled) return;
  appState.ws.send(JSON.stringify({ candles: appState.symbol, granularity: appState.trend.tfSeconds, count: 80, end:"latest" }));
}
function maybeRefreshTrend(){
  if (!appState.trend.enabled) return;
  const now = Date.now();
  if (now - appState.trend.lastUpdated < appState.trend.refreshMs) return;
  appState.trend.lastUpdated = now;
  requestH4Candles();
}
function trendAllows(direction){
  if (!appState.trend.enabled) return true;
  if (appState.trend.status === "LOADING") return false;
  if (direction === "CALL") return appState.trend.status === "BULL";
  if (direction === "PUT") return appState.trend.status === "BEAR";
  return false;
}

/* =========================================================
   SIGNALS
========================================================= */
function getMomentumDirection(){
  if (appState.tickBuffer.length < appState.tickBufferSize) return null;
  const first = appState.tickBuffer[0];
  const last  = appState.tickBuffer[appState.tickBuffer.length-1];
  const delta = last-first;
  if (Math.abs(delta) < appState.momentumThreshold) return null;
  return delta > 0 ? "CALL" : "PUT";
}
function passesBreakoutFilter(direction){
  if (!appState.breakoutStrict) return true;
  const buf = appState.tickBuffer;
  if (buf.length < appState.tickBufferSize) return false;
  const last = buf[buf.length-1];
  const hi = Math.max(...buf);
  const lo = Math.min(...buf);
  const span = hi-lo || 1;
  if (direction === "CALL") return (hi-last) <= (span*0.15);
  if (direction === "PUT")  return (last-lo) <= (span*0.15);
  return false;
}

/* =========================================================
   CLUSTERING (simple)
========================================================= */
function updateClustering(price){
  const s = String(price);
  const lastChar = s.replace(/\\D/g,'').slice(-1) || "0";
  const d = parseInt(lastChar,10);

  appState.lastDigits.push(d);
  while(appState.lastDigits.length > 5) appState.lastDigits.shift();
  if (appState.lastDigits.length < 5) return;

  let sameCount = 0;
  for (let i=1;i<appState.lastDigits.length;i++){
    if (appState.lastDigits[i] === appState.lastDigits[i-1]) sameCount++;
  }

  if (sameCount >= 3){
    dom.clusterAlert?.classList.remove("hidden");
    if (dom.clusterText) dom.clusterText.textContent = `Clustering Detected: ${sameCount} repeats in last 5 ticks → possible reversal/indecision.`;
  } else {
    dom.clusterAlert?.classList.add("hidden");
  }
}

/* =========================================================
   DERIV WS
========================================================= */
function connectToDeriv(){
  try{
    appState.ws = new WebSocket(API_URL);
  }catch(e){
    logLine("WebSocket create failed: " + e.message);
    updateConnection("ERROR", "bg-red-600 text-white");
    return;
  }

  updateConnection("CONNECTING...", "bg-yellow-600 text-white");
  logLine("Connecting to Deriv...");

  appState.ws.onopen = () => {
    logLine("WS open. Authorizing...");
    updateConnection("CONNECTED", "bg-sky-600 text-white");
    appState.ws.send(JSON.stringify({ authorize: appState.token }));
  };

  appState.ws.onclose = () => {
    appState.isAuthenticated = false;
    logLine("WS closed.");
    if (appState.isBotRunning){
      updateConnection("RECONNECTING...", "bg-yellow-600 text-white");
      setTimeout(connectToDeriv, 2500);
    } else {
      updateConnection("DISCONNECTED", "bg-red-800 text-white");
    }
  };

  appState.ws.onerror = () => {
    logLine("WS error (see console).");
    updateConnection("ERROR", "bg-red-600 text-white");
  };

  appState.ws.onmessage = (msg) => {
    let data=null;
    try{ data = JSON.parse(msg.data); }catch(e){
      logLine("Bad JSON received.");
      return;
    }
    handleResponse(data);
  };
}

function subscribeTicks(symbol){
  if (!appState.ws || !appState.isAuthenticated) return;
  try { appState.ws.send(JSON.stringify({ forget_all: "ticks" })); } catch(_){}
  appState.ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
  logLine("Subscribing ticks: " + symbol);
}

/* =========================================================
   START/STOP (password gate)
========================================================= */
function startBot(){
  if (appState.isBotRunning) return;

  const token = (dom.apiToken?.value || "").trim();
  const pw    = (dom.pwInput?.value || "").trim();

  // gate checks
  if (!token){
    dom.tokenError?.classList.remove("hidden");
    logLine("Start blocked: missing API token.");
    updateTradeStatus("ERROR: Enter API Token", "bg-red-600 text-white");
    return;
  } else dom.tokenError?.classList.add("hidden");

  if (pw !== START_PASSWORD){
    dom.pwError?.classList.remove("hidden");
    logLine("Start blocked: wrong password.");
    updateTradeStatus("ERROR: Wrong Password", "bg-red-600 text-white");
    return;
  } else dom.pwError?.classList.add("hidden");

  localStorage.setItem("derivToken", token);
  appState.token = token;

  // reset session
  appState.sessionProfit = 0;
  appState.tradeCounter = 0;
  appState.currentContractId = null;
  appState.isEntryInProgress = false;
  appState.isSelling = false;
  appState.cooldownUntil = 0;
  appState.tickBuffer = [];
  appState.pendingProposalId = null;
  appState.lastDigits = [];

  // reset chart state
  appState.chart.lastCandleTime = 0;
  appState.chart.lastOHLC = null;
  appState.chart.hasTick = false;

  updateProfit(appState.sessionProfit);

  // init chart once per start (safe)
  initChart();

  appState.isBotRunning = true;
  updateUI();
  connectToDeriv();

  setPill(dom.chartStatus, "WAITING", "bg-slate-700 text-slate-200");
  logLine("Bot started (PW OK).");
}

function stopBot(){
  try{ if (appState.ws) appState.ws.close(); }catch(_){}
  appState.ws = null;

  appState.isBotRunning = false;
  appState.isAuthenticated = false;
  appState.isEntryInProgress = false;
  appState.currentContractId = null;
  appState.isSelling = false;
  appState.tickBuffer = [];
  appState.cooldownUntil = 0;
  appState.pendingProposalId = null;

  updateConnection("DISCONNECTED", "bg-red-800 text-white");
  updateTradeStatus("Stopped.", "bg-slate-600 text-slate-300");
  dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "None");
  setPill(dom.chartStatus, "WAITING", "bg-slate-700 text-slate-200");

  logLine("Bot stopped.");
  updateUI();
}

/* =========================================================
   TRADE ENGINE (same style: TP sells, SL sells only Safe Mode)
========================================================= */
function checkAndEnterTrade(){
  if (!appState.isBotRunning || !appState.isAuthenticated) return;

  if (Date.now() < appState.cooldownUntil){
    dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Cooldown");
    return;
  }
  if (appState.isEntryInProgress){
    dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Entry In Progress");
    return;
  }
  if (appState.currentContractId){
    dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Trade Active");
    return;
  }
  if (appState.tradeCounter >= appState.maxTradesPerSignal){
    dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Max Trades/Signal Hit");
    return;
  }

  const direction = getMomentumDirection();
  if (!direction){
    dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Waiting Good Move");
    return;
  }
  if (!passesBreakoutFilter(direction)){
    dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Waiting Breakout");
    return;
  }
  if (appState.trend.enabled){
    if (appState.trend.status === "LOADING"){
      dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "H4 Trend Loading");
      return;
    }
    if (!trendAllows(direction)){
      dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = `H4 Trend Blocked (${appState.trend.status})`);
      return;
    }
  }

  dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "None");
  enterTrade(direction, appState.stakeAmount);
}

function enterTrade(direction, stake){
  if (!appState.ws || !appState.isAuthenticated) return;

  appState.isEntryInProgress = true;
  appState.pendingProposalId = null;
  appState.tickBuffer = [];
  updateTradeStatus(`Creating Proposal (${direction})...`, "bg-orange-500 text-white");

  const req = {
    proposal: 1,
    amount: stake,
    basis: "stake",
    contract_type: direction,
    currency: "USD",
    duration: appState.duration,
    duration_unit: appState.durationUnit,
    symbol: appState.symbol
  };
  appState.ws.send(JSON.stringify(req));

  setTimeout(() => {
    if (!appState.isBotRunning) return;
    if (appState.currentContractId) return;
    if (appState.isEntryInProgress){
      appState.isEntryInProgress = false;
      updateTradeStatus("Monitoring Ticks...", "bg-yellow-600 text-white");
      dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Entry Timeout");
      logLine("Entry timeout. Reset.");
    }
  }, 10000);

  appState.tradeCounter++;
}

function checkProfitAndLoss(contract){
  const currentProfit = Number(contract.profit);

  // TP: sell if sellable
  if (currentProfit >= appState.tpUSD){
    sellContract();
    return;
  }

  // SL: only if Safe Mode ON
  if (appState.isSafeMode){
    const lossThreshold = -Math.abs(appState.slUSD);
    if (currentProfit <= lossThreshold){
      sellContract();
    }
  }
}

function sellContract(){
  if (appState.isSelling) return;
  if (!appState.currentContractId) return;

  if (appState.is_sellable !== 1){
    dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Not Sellable");
    return;
  }

  appState.isSelling = true;
  updateTradeStatus("Selling...", "bg-red-500 text-white");
  appState.ws.send(JSON.stringify({ sell: appState.currentContractId, price: 0 }));
  logLine("Sell requested.");
}

/* =========================================================
   RESPONSES
========================================================= */
function handleResponse(res){
  if (res.error){
    const msg = res.error.message || "Unknown API error";
    logLine("API Error: " + msg);

    // token/account mismatch info
    if (String(msg).toLowerCase().includes("authorization")){
      dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Auth Failed");
      stopBot();
      return;
    }

    // symbol problems: warn about account type
    if (String(msg).toLowerCase().includes("market") || String(msg).toLowerCase().includes("symbol")){
      dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Symbol not available on this account");
      updateTradeStatus("SYMBOL ERROR", "bg-red-600 text-white");
      logLine("If this is an MT5/financial-only setup, use a Derived/Synthetic account API token for VOL indices.");
    }
    return;
  }

  switch(res.msg_type){

    case "authorize": {
      appState.isAuthenticated = true;

      // demo/real detection (your request)
      const isVirtual = !!res.authorize.is_virtual;
      appState.account.isDemo = isVirtual;
      updateAccountTypeUI();

      const bal = Number(res.authorize.balance || 0);
      appState.currentBalance = bal;
      if (dom.balanceDisplay){
        dom.balanceDisplay.textContent = `${res.authorize.currency || "USD"} ${bal.toFixed(2)}`;
      }

      logLine("Authorized (" + (isVirtual ? "DEMO" : "REAL") + ").");

      // subscribe ticks + balance + contract stream
      subscribeTicks(appState.symbol);
      appState.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
      appState.ws.send(JSON.stringify({ proposal_open_contract: 1, subscribe: 1 }));

      // trend
      appState.trend.lastUpdated = 0;
      if (appState.trend.enabled){
        appState.trend.status = "LOADING";
        requestH4Candles();
      } else {
        appState.trend.status = "OFF";
      }

      updateTradeStatus("Monitoring Ticks...", "bg-yellow-600 text-white");
      dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "None");
      setPill(dom.chartStatus, "LIVE", "bg-sky-700 text-white");
      updateUI();
      break;
    }

    case "balance": {
      const bal = Number(res.balance.balance || 0);
      appState.currentBalance = bal;
      if (dom.balanceDisplay){
        dom.balanceDisplay.textContent = `${res.balance.currency || "USD"} ${bal.toFixed(2)}`;
      }
      break;
    }

    case "tick": {
      if (!appState.isBotRunning) return;

      const price = Number(res.tick.quote);
      if (!Number.isFinite(price)) return;

      // chart + buffers
      updateChartFromTick(price);
      updateClustering(price);

      appState.lastTick = price;
      appState.tickBuffer.push(price);
      while(appState.tickBuffer.length > appState.tickBufferSize) appState.tickBuffer.shift();

      maybeRefreshTrend();

      // confidence always updates (manual use too)
      renderConfidence();

      if (appState.autoTradingEnabled) checkAndEnterTrade();

      updateUI();
      break;
    }

    case "candles": {
      if (!res.candles || !Array.isArray(res.candles)){
        appState.trend.status = "ERROR";
        logLine("Trend candles error.");
        updateUI();
        return;
      }
      const closes = res.candles.map(c => parseFloat(c.close)).filter(n => Number.isFinite(n));
      const ema20 = calcEMA(closes, appState.trend.emaFast);
      const ema50 = calcEMA(closes, appState.trend.emaSlow);
      appState.trend.status = trendClassify(ema20, ema50);
      updateUI();
      break;
    }

    case "proposal": {
      if (!appState.isEntryInProgress) return;
      if (!res.proposal?.id){
        appState.isEntryInProgress = false;
        logLine("Proposal missing ID.");
        return;
      }
      appState.pendingProposalId = res.proposal.id;
      appState.ws.send(JSON.stringify({ buy: appState.pendingProposalId, price: appState.stakeAmount }));
      break;
    }

    case "buy": {
      appState.isEntryInProgress = false;
      appState.pendingProposalId = null;
      appState.currentContractId = res.buy.contract_id;
      updateTradeStatus("Contract Active", "bg-indigo-600 text-white");
      logLine("Bought contract: " + appState.currentContractId);
      break;
    }

    case "proposal_open_contract": {
      const c = res.proposal_open_contract;
      if (!c) return;

      setSellable(c.is_sellable);

      // only manage OUR contract
      if (appState.currentContractId && c.contract_id === appState.currentContractId){
        if (c.is_sold === 1){
          const profit = Number(c.sell_price) - Number(c.buy_price);
          appState.sessionProfit += profit;
          updateProfit(appState.sessionProfit);

          appState.currentContractId = null;
          appState.isSelling = false;
          appState.tickBuffer = [];
          appState.tradeCounter = 0;

          appState.cooldownUntil = Date.now() + (appState.cooldownDuration * 1000);
          dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "Cooldown");
          updateTradeStatus("Trade Closed. Cooldown...", "bg-orange-500 text-white");
          logLine("Trade closed. Profit: " + profit.toFixed(2));

          if (appState.autoResume){
            setTimeout(() => {
              if (!appState.isBotRunning) return;
              if (Date.now() >= appState.cooldownUntil){
                dom.blockReasonDisplay && (dom.blockReasonDisplay.textContent = "None");
                updateTradeStatus("Monitoring Ticks...", "bg-yellow-600 text-white");
              }
            }, appState.cooldownDuration * 1000);
          }
        } else {
          checkProfitAndLoss(c);
        }
      }
      updateUI();
      break;
    }
  }
}

/* =========================================================
   MANUAL CONTROLS
========================================================= */
function manualPlaceTrade(mult=1){
  if (!appState.isAuthenticated){
    logLine("Manual trade blocked: not connected.");
    updateTradeStatus("Connect first.", "bg-red-600 text-white");
    return;
  }
  if (appState.currentContractId || appState.isEntryInProgress){
    logLine("Manual trade blocked: trade already active.");
    return;
  }

  const dir = getMomentumDirection();
  if (!dir){
    updateTradeStatus("WAIT: no signal", "bg-yellow-600 text-white");
    logLine("Manual trade: no momentum signal yet.");
    return;
  }
  if (appState.trend.enabled && !trendAllows(dir)){
    updateTradeStatus("AVOID: trend mismatch", "bg-yellow-600 text-white");
    logLine("Manual trade blocked: trend mismatch.");
    return;
  }
  if (!passesBreakoutFilter(dir)){
    updateTradeStatus("WAIT: breakout not clean", "bg-yellow-600 text-white");
    logLine("Manual trade: breakout not clean.");
    return;
  }

  enterTrade(dir, appState.stakeAmount * mult);
}

function clearHistory(){
  appState.sessionProfit = 0;
  updateProfit(appState.sessionProfit);
  logLine("History cleared (session profit reset).");
}

/* =========================================================
   SYMBOL SWITCHING (chart + ticks + trend)
========================================================= */
function setSymbol(newSymbol){
  newSymbol = (newSymbol || "").trim();
  if (!newSymbol) return;

  appState.symbol = newSymbol;
  if (dom.currentSymbolLabel) dom.currentSymbolLabel.textContent = newSymbol;

  // reset buffers + chart candle state
  appState.tickBuffer = [];
  appState.lastDigits = [];
  appState.chart.lastCandleTime = 0;
  appState.chart.lastOHLC = null;

  // trend refresh
  appState.trend.lastUpdated = 0;
  if (appState.trend.enabled) appState.trend.status = "LOADING";

  if (appState.isAuthenticated){
    subscribeTicks(newSymbol);
    requestH4Candles();
    logLine("Symbol switched to: " + newSymbol);
  } else {
    logLine("Symbol set (will subscribe after connect): " + newSymbol);
  }

  setPill(dom.chartStatus, "LIVE", "bg-sky-700 text-white");
  updateUI();
}

/* =========================================================
   INSIGHTS (fallback)
========================================================= */
function fallbackInsight(type){
  const trend = appState.trend.enabled ? appState.trend.status : "OFF";
  const dir = getMomentumDirection() || "NONE";
  const buf = appState.tickBuffer;
  const first = buf.length ? buf[0] : null;
  const last  = buf.length ? buf[buf.length-1] : null;
  const delta = (first!=null && last!=null) ? (last-first) : 0;
  const conf = computeConfidence().toFixed(0);

  if (type === "sentiment"){
    return [
      `Safe Entry Suggestion (Fallback):`,
      `• Symbol: ${appState.symbol}`,
      `• Mode: ${appState.mode}`,
      `• Trend Filter: ${trend}`,
      `• Momentum: ${dir} | Δ=${delta.toFixed(4)}`,
      `• Confidence: ${conf}%`,
      `• Breakout Strict: ${appState.breakoutStrict ? "ON" : "OFF"}`,
      ``,
      `Suggested Action:`,
      dir === "NONE" ? "• WAIT (not enough momentum)" :
      (appState.trend.enabled && !trendAllows(dir)) ? `• AVOID (trend not aligned)` :
      (!passesBreakoutFilter(dir)) ? "• WAIT (breakout not clean yet)" :
      "• OK (conditions passing — still risk-manage)",
      ``,
      `Reminder: Synthetics move fast. Keep stake small.`
    ].join("\\n");
  }

  return [
    `Risk Check (Fallback):`,
    `• Stake: $${appState.stakeAmount.toFixed(2)}`,
    `• TP: $${appState.tpUSD.toFixed(2)} | SL: $${appState.slUSD.toFixed(2)} (SL sells only if Safe Mode ON)`,
    `• Duration: ${appState.duration} ${appState.durationUnit}`,
    `• Cooldown: ${appState.cooldownDuration}s`,
    `• Auto Trading: ${appState.autoTradingEnabled ? "ON" : "OFF"}`,
    `• Session P/L: $${appState.sessionProfit.toFixed(2)}`
  ].join("\\n");
}

async function showInsight(type){
  if (!dom.geminiOut) return;
  dom.geminiLoading?.classList.remove("hidden");
  dom.geminiOut.textContent = "Analyzing...";
  await new Promise(r => setTimeout(r, 350));
  dom.geminiOut.textContent = fallbackInsight(type);
  dom.geminiLoading?.classList.add("hidden");
}

/* =========================================================
   TOKEN / COPY / VISIBILITY
========================================================= */
function toggleTokenVisibility(){
  if (!dom.apiToken) return;
  dom.apiToken.type = (dom.apiToken.type === "password") ? "text" : "password";
}

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  try{
    // preload token
    if (appState.token && dom.apiToken){
      dom.apiToken.value = appState.token;
      logLine("Token loaded from browser storage.");
    }

    // init chart once at load (safe)
    initChart();

    // defaults
    loadDefaults(appState.mode);
    setSettingsLock(true);

    // default symbol select
    if (dom.symbolSelect) dom.symbolSelect.value = appState.symbol;

    // bind inputs
    document.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("input", updateStateFromUI);
      el.addEventListener("change", updateStateFromUI);
    });

    // buttons
    dom.toggleBotBtn?.addEventListener("click", () => {
      if (appState.isBotRunning) stopBot();
      else startBot();
    });

    dom.unlockBtn?.addEventListener("click", () => setSettingsLock(!appState.isSettingsLocked));
    dom.modeSelect?.addEventListener("change", (e) => loadDefaults(e.target.value));
    dom.safeToggle?.addEventListener("change", (e) => { appState.isSafeMode = !!e.target.checked; updateUI(); });
    dom.autoResumeToggle?.addEventListener("change", (e) => { appState.autoResume = !!e.target.checked; updateUI(); });

    dom.toggleVisibilityBtn?.addEventListener("click", toggleTokenVisibility);

    dom.analyzeBtn?.addEventListener("click", () => showInsight("sentiment"));
    dom.riskBtn?.addEventListener("click", () => showInsight("risk"));

    dom.symbolSelect?.addEventListener("change", (e) => setSymbol(e.target.value));
    dom.applySymbolBtn?.addEventListener("click", () => setSymbol(dom.customSymbol?.value));

    dom.placeTradeBtn?.addEventListener("click", () => manualPlaceTrade(1));
    dom.bulk3Btn?.addEventListener("click", () => manualPlaceTrade(3));
    dom.bulk5Btn?.addEventListener("click", () => manualPlaceTrade(5));
    dom.clearHistoryBtn?.addEventListener("click", clearHistory);

    dom.autoTradingToggle?.addEventListener("change", (e) => {
      appState.autoTradingEnabled = !!e.target.checked;
      logLine("Auto Trading: " + (appState.autoTradingEnabled ? "ON" : "OFF"));
      updateUI();
    });

    dom.clearLogBtn?.addEventListener("click", () => { if (LOG) LOG.textContent = ""; });
    dom.exportLogBtn?.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(LOG?.textContent || "");
        logLine("Log copied to clipboard.");
      }catch(e){
        logLine("Copy log failed (browser blocked).");
      }
    });

    // initial UI
    updateConnection("DISCONNECTED", "bg-red-800 text-white");
    updateTradeStatus("Idle", "bg-slate-600 text-slate-300");
    setSellable(0);
    updateProfit(appState.sessionProfit);
    renderConfidence();
    updateUI();

    logLine("Kut Milz TB loaded. Ready.");
  }catch(e){
    logLine("Init error: " + e.message);
  }
});
</script>
</body>
</html>
