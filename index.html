<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kut Milz TB</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
body{
  background:#0f172a;
  color:#e2e8f0;
  font-family:Inter,system-ui,sans-serif;
  padding:16px;
}
.card{
  background:#1e293b;
  border:1px solid #334155;
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}
.pill{
  padding:4px 10px;
  border-radius:9999px;
  font-size:12px;
  font-weight:600;
}
#chart-container{
  height:320px;
  background:#0b1220;
  border-radius:12px;
}
</style>
</head>

<body>

<h1 class="text-3xl font-bold text-center mb-6">Kut Milz TB</h1>

<div class="card">
  <div class="flex justify-between items-center">
    <span>Connection</span>
    <span id="connection-status" class="pill bg-red-700">DISCONNECTED</span>
  </div>
  <div class="flex justify-between items-center mt-2">
    <span>Account</span>
    <span id="account-type" class="pill bg-slate-600">UNKNOWN</span>
  </div>
</div>

<div class="card">
  <button id="toggle-bot"
    class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 rounded-xl font-bold">
    START BOT
  </button>
</div>

<div class="card">
  <h2 class="font-semibold mb-2">Live Chart</h2>
  <div id="chart-container"></div>
  <div id="chart-status" class="pill bg-slate-700 mt-2">WAITING</div>
</div>

<div class="card">
  <h2 class="font-semibold mb-2">Confidence Meter</h2>
  <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
    <div id="confidence-bar" class="h-4 bg-emerald-500" style="width:0%"></div>
  </div>
  <div id="confidence-text" class="text-xs mt-1 text-slate-300">0%</div>
</div>

<div class="card">
  <h2 class="font-semibold mb-2">System Log</h2>
  <pre id="log" class="text-xs h-40 overflow-auto"></pre>
</div>

<script>
/* ========= helpers ========= */
const log = msg => {
  const l = document.getElementById("log");
  const t = new Date().toLocaleTimeString();
  l.textContent += `[${t}] ${msg}\n`;
  l.scrollTop = l.scrollHeight;
};
const setPill = (id,text,cls)=>{
  const el=document.getElementById(id);
  el.textContent=text;
  el.className=`pill ${cls}`;
};

/* ========= state ========= */
const state={
  ws:null,
  running:false,
  symbol:"R_100",
  ticks:[],
  chart:null,
  series:null,
  isDemo:false
};

/* ========= chart ========= */
function initChart(){
  const c=document.getElementById("chart-container");
  state.chart=LightweightCharts.createChart(c,{
    layout:{background:{color:"#0b1220"},textColor:"#e2e8f0"},
    timeScale:{timeVisible:true,secondsVisible:true}
  });

  // SAFE: try candles, fallback to line
  try{
    if(state.chart.addCandlestickSeries){
      state.series=state.chart.addCandlestickSeries();
      log("Chart ready (candles)");
    }else{
      throw "no candle support";
    }
  }catch{
    state.series=state.chart.addLineSeries();
    log("Chart ready (line fallback)");
  }

  setPill("chart-status","LIVE","bg-emerald-600");
}

/* ========= confidence ========= */
function updateConfidence(){
  if(state.ticks.length<5){
    setConfidence(0);return;
  }
  const a=state.ticks[0];
  const b=state.ticks[state.ticks.length-1];
  const move=Math.abs(b-a);
  let score=Math.min(100,move*1000);
  setConfidence(score);
}
function setConfidence(v){
  const bar=document.getElementById("confidence-bar");
  const txt=document.getElementById("confidence-text");
  bar.style.width=v+"%";
  bar.className=`h-4 ${v>70?"bg-emerald-500":v>40?"bg-yellow-500":"bg-red-500"}`;
  txt.textContent=`${v.toFixed(0)}%`;
}

/* ========= deriv ========= */
function connect(){
  state.ws=new WebSocket("wss://ws.binaryws.com/websockets/v3?app_id=1089");
  setPill("connection-status","CONNECTING","bg-yellow-600");

  state.ws.onopen=()=>{
    state.ws.send(JSON.stringify({authorize:localStorage.derivToken||""}));
  };

  state.ws.onmessage=e=>{
    const d=JSON.parse(e.data);

    if(d.msg_type==="authorize"){
      setPill("connection-status","CONNECTED","bg-emerald-600");
      state.isDemo=d.authorize.is_virtual;
      setPill("account-type",state.isDemo?"DEMO":"REAL",
        state.isDemo?"bg-yellow-600":"bg-emerald-600");
      log("Authorized");
      state.ws.send(JSON.stringify({ticks:state.symbol,subscribe:1}));
    }

    if(d.msg_type==="tick"){
      const p=d.tick.quote;
      state.ticks.push(p);
      if(state.ticks.length>20) state.ticks.shift();

      const t=Math.floor(Date.now()/1000);
      state.series.update({time:t,value:p,open:p,high:p,low:p,close:p});

      updateConfidence();
    }
  };

  state.ws.onclose=()=>{
    setPill("connection-status","DISCONNECTED","bg-red-700");
    log("Disconnected");
  };
}

/* ========= UI ========= */
document.getElementById("toggle-bot").onclick=()=>{
  if(!state.running){
    state.running=true;
    initChart();
    connect();
    document.getElementById("toggle-bot").textContent="STOP BOT";
  }else{
    state.running=false;
    state.ws?.close();
    document.getElementById("toggle-bot").textContent="START BOT";
  }
};

log("Kut Milz TB loaded. Ready.");
</script>

</body>
</html>
